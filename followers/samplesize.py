"""
Module to estimate the minimal subsample size, assuming
the sample size is calculated with respect to estimating the
population mean.

The script can be run from the command line.
"""

import argparse


def sampleSize(
    population_size,
    margin_error=.05,
    confidence_level=.99,
    sigma=1/2
):
    """
    Calculate the minimal sample size to use to achieve a certain
    margin of error and confidence level for a sample estimate
    of the population mean.

    Inputs
    -------
    population_size: integer
        Total size of the population that the sample is to be drawn from.

    margin_error: number
        Maximum expected difference between the true population parameter,
        such as the mean, and the sample estimate.

    confidence_level: number in the interval (0, 1)
        If we were to draw a large number of equal-size samples
        from the population, the true population parameter
        should lie within this percentage
        of the intervals (sample_parameter - e, sample_parameter + e)
        where e is the margin_error.

    sigma: number
        The standard deviation of the population.  For the case
        of estimating a parameter in the interval [0, 1], sigma=1/2
        should be sufficient.

    """
    alpha = 1 - (confidence_level)
    # dictionary of confidence levels and corresponding z-scores
    # computed via norm.ppf(1 - (alpha/2)), where norm is
    # a normal distribution object in scipy.stats.
    # Here, ppf is the percentile point function.
    zdict = {
        .90: 1.645,
        .91: 1.695,
        .99: 2.576,
        .97: 2.17,
        .94: 1.881,
        .93: 1.812,
        .95: 1.96,
        .98: 2.326,
        .96: 2.054,
        .92: 1.751
    }
    if confidence_level in zdict:
        z = zdict[confidence_level]
    else:
        from scipy.stats import norm
        z = norm.ppf(1 - (alpha/2))
    N = population_size
    M = margin_error
    numerator = z**2 * sigma**2 * (N / (N-1))
    denom = M**2 + ((z**2 * sigma**2)/(N-1))
    return numerator/denom


def main():
    n = sampleSize(args.size, args.error, args.confidence, args.deviation)
    print(n)
    return n


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Update interest distributions.'
    )
    parser.add_argument(
        '-s',
        '--size',
        type=int,
        help='Population size the sample is drawn from.'
    )
    parser.add_argument(
        '-e',
        '--error',
        type=float,
        default=.05,
        help='Margin of error.'
    )
    parser.add_argument(
        '-c',
        '--confidence',
        type=float,
        default=.99,
        help='Confidence level.'
    )
    parser.add_argument(
        '-d',
        '--deviation',
        type=float,
        default=1/2,
        help='Population variance if know.'
    )
    args = parser.parse_args()
    main()
